name: Date-Based Release

on:
  push:
    branches:
      - main

permissions:
  contents: write # Required to push tags

jobs:
  date-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v6
        with:
          go-version: '1.25.5'

      # 1. Run Tests
      - name: Run Tests
        run: go test -v ./...

      # 2. Generate Tag and Push
      - name: Create Date Tag
        id: tag
        run: |
          # Get latest tag (e.g. v1.0.0). If none, default to v0.0.0
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          
          # Use the latest tag as base, but append timestamp for unique pre-release (pseudo-ish)
          # Note: v1.0.0-timestamp is LOWER than v1.0.0. 
          # To ensure it increases, we typically need to increment patch, e.g. v1.0.1-timestamp
          
          # For now, let's keep it simple: Just use the timestamp as the build metadata or pre-release
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          
          # Logic: If we are on main, we might want to just be "Latest Commit".
          # But to supersede v1.0.0, we need v1.0.1-something.
          
          # Let's hardcode base to v1.0.1 for now since we are cleaning up v1.0.0
          VERSION="v1.0.1-$TIMESTAMP"
          
          echo "Creating tag: $VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git tag $VERSION
          git push origin $VERSION
          
          echo "tag_name=$VERSION" >> $GITHUB_OUTPUT

      # 3. Refresh Proxy
      - name: Refresh pkg.go.dev
        continue-on-error: true
        env:
          GOPROXY: https://proxy.golang.org
        run: |
          go list -m github.com/leeineian/gauth@${{ steps.tag.outputs.tag_name }}
